<script context="module" >import { onMount, createEventDispatcher } from 'svelte';
import { loadScript, removeScript } from './utils';
</script>

<script >export let clientId;
export let scope = 'profile email';
export let redirectUri = undefined;
export let cookiePolicy = 'single_host_origin';
export let loginHint = undefined;
export let hostedDomain = undefined;
export let prompt = '';
export let responseType = undefined;
export let autoLoad = undefined;
export let uxMode = 'popup';
export let fetchBasicProfile = true;
export let isSignedIn = false;
export let discoveryDocs = undefined;
export let accessType = 'online';
export let script = 'https://apis.google.com/js/api.js';
const dispatch = createEventDispatcher();
let loaded = false;
const handleSignInSuccess = (res) => {
    const basicProfile = res.getBasicProfile();
    const authResponse = res.getAuthResponse(true);
    res.googleId = basicProfile.getId();
    res.tokenObj = authResponse;
    res.accessToken = authResponse.access_token;
    res.profileObj = {
        googleId: basicProfile.getId(),
        imageUrl: basicProfile.getImageUrl(),
        email: basicProfile.getEmail(),
        name: basicProfile.getName(),
        givenName: basicProfile.getGivenName(),
        familyName: basicProfile.getFamilyName(),
    };
    dispatch('success', res);
};
const signIn = (e) => {
    if (e)
        e.preventDefault();
    if (loaded) {
        const GoogleAuth = window.gapi.auth2.getAuthInstance();
        const options = { prompt };
        dispatch('request');
        if (responseType === 'code')
            GoogleAuth.grantOfflineAccess(options).then((res) => dispatch('success', res), (err) => dispatch('failure', err));
        else
            GoogleAuth.signIn(options).then((res) => handleSignInSuccess(res), (err) => dispatch('failure', err));
    }
};
onMount(() => {
    let unmounted = false;
    loadScript(script, 'google-login')
        .then(() => {
        const params = {
            client_id: clientId,
            cookie_policy: cookiePolicy,
            login_hint: loginHint,
            hosted_domain: hostedDomain,
            fetch_basic_profile: fetchBasicProfile,
            discoveryDocs,
            ux_mode: uxMode,
            redirect_uri: redirectUri,
            scope,
            access_type: accessType
        };
        if (responseType === 'code') {
            params.access_type = 'offline';
        }
        window.gapi.load('auth2', () => {
            const GoogleAuth = window.gapi.auth2.getAuthInstance();
            if (!GoogleAuth) {
                window.gapi.auth2.init(params).then((res) => {
                    if (!unmounted) {
                        loaded = true;
                        const signedIn = isSignedIn && res.isSignedIn.get();
                        dispatch('autoLoadFinished', signedIn);
                        if (signedIn) {
                            handleSignInSuccess(res.currentUser.get());
                        }
                    }
                }, (err) => {
                    loaded = true;
                    dispatch('autoLoadFinished', false);
                    dispatch('failure', err);
                });
            }
            else {
                GoogleAuth.then(() => {
                    if (unmounted)
                        return;
                    if (isSignedIn && GoogleAuth.isSignedIn.get()) {
                        loaded = true;
                        dispatch('autoLoadFinished', true);
                        handleSignInSuccess(GoogleAuth.currentUser.get());
                    }
                    else {
                        loaded = true;
                        dispatch('autoLoadFinished', false);
                    }
                }, (err) => dispatch('failure', err));
            }
        });
    })
        .catch((err) => dispatch('failure', err));
    return () => {
        unmounted = true;
        removeScript('google-login');
    };
});
const onLoadedChange = (loaded) => {
    if (autoLoad)
        signIn();
};
$: onLoadedChange(loaded);
</script>

<slot {signIn} disabled={!loaded}></slot>